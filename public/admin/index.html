<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×©××™×¨×ª ×× ×©×™ ×§×©×¨ - Botomat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-hover: #3a56d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #1f2937;
            --text-light: #6b7280;
            --bg: #f3f4f6;
            --white: #ffffff;
            --border: #e5e7eb;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Heebo', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
        }
        
        .login-card h1 { text-align: center; margin-bottom: 2rem; font-size: 1.75rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }
        .form-group input:focus { outline: none; border-color: var(--primary); }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-block { width: 100%; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.9rem; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: var(--bg); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-success { background: var(--success); color: var(--white); }
        
        .btn-google {
            background: var(--white);
            border: 2px solid var(--border);
            color: var(--text);
            margin-top: 1rem;
            width: 100%;
        }
        .btn-google:hover { background: var(--bg); }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            color: var(--text-light);
        }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .divider::before { margin-left: 1rem; }
        .divider::after { margin-right: 1rem; }
        
        .error-msg {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        .error-msg.show { display: block; }
        
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .login-page.hidden { display: none; }
        
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .header-actions { display: flex; gap: 1rem; align-items: center; }
        
        .main-content { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
        }
        .tab:hover { background: var(--bg); }
        .tab.active { background: var(--primary); color: white; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: var(--shadow);
        }
        .stat-card h3 { color: var(--text-light); font-size: 0.85rem; margin-bottom: 0.5rem; }
        .stat-card .value { font-size: 1.75rem; font-weight: 700; }
        .stat-card .value.primary { color: var(--primary); }
        .stat-card .value.success { color: var(--success); }
        .stat-card .value.warning { color: var(--warning); }
        .stat-card .value.danger { color: var(--danger); }
        
        /* Search and Filters */
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }
        .search-box input:focus { outline: none; border-color: var(--primary); }
        .search-box::before {
            content: 'ğŸ”';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
        }
        .filter-select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
            background: var(--white);
            cursor: pointer;
        }
        
        /* Customer Cards */
        .customers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        .customer-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .customer-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        .customer-card-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .customer-info h3 { font-size: 1.1rem; margin-bottom: 0.25rem; }
        .customer-info .phone { color: var(--text-light); font-size: 0.9rem; direction: ltr; text-align: right; }
        .customer-status { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .badge-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        
        .customer-card-stats {
            padding: 1.25rem;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            text-align: center;
        }
        .mini-stat { padding: 0.5rem; }
        .mini-stat .label { font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem; }
        .mini-stat .value { font-size: 1.25rem; font-weight: 700; }
        
        .customer-card-footer {
            padding: 1rem 1.25rem;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-light);
        }
        .last-hour-badge {
            background: var(--success);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* Error styling */
        .customer-card.has-error {
            border: 2px solid var(--danger);
        }
        .error-banner {
            background: #fef2f2;
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-top: 1px solid #fecaca;
            border-bottom: 1px solid #fecaca;
        }
        
        /* Campaign Cards */
        .campaign-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.25rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .campaign-card:hover { transform: translateY(-2px); }
        .campaign-card h3 { margin-bottom: 0.75rem; font-size: 1.1rem; }
        .campaign-stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .campaign-stats .stat {
            text-align: center;
        }
        .campaign-stats .stat .label { font-size: 0.75rem; color: var(--text-light); }
        .campaign-stats .stat .value { font-size: 1.25rem; font-weight: 700; }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--white);
            border-radius: var(--radius);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-header h2 { font-size: 1.5rem; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0.5rem;
        }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex: 1; }
        
        .detail-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .detail-stat {
            background: var(--bg);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }
        .detail-stat .label { font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .detail-stat .value { font-size: 1.5rem; font-weight: 700; }
        
        .campaign-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }
        .campaign-table th, .campaign-table td {
            padding: 0.875rem 1rem;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }
        .campaign-table th {
            background: var(--bg);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-light);
        }
        .campaign-table tr:hover td { background: rgba(67, 97, 238, 0.05); }
        
        .error-alert {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .error-alert .type { font-weight: 600; color: var(--danger); margin-bottom: 0.5rem; }
        .error-alert .message { color: var(--text); }
        
        .labels-section { margin-bottom: 1.5rem; }
        .labels-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
        .label-tag {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .loading { text-align: center; padding: 3rem; color: var(--text-light); }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .section-title { margin: 1rem 0; font-size: 1rem; color: var(--text-light); }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }
        
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 1rem; padding: 1rem; }
            .main-content { padding: 1rem; }
            .customers-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
            .search-box { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container login-page">
        <div class="login-card">
            <h1>ğŸ” ×›× ×™×¡×ª ×× ×”×œ</h1>
            <div id="errorMsg" class="error-msg"></div>
            
            <form id="setupForm" style="display: none;">
                <p style="margin-bottom: 1.5rem; color: var(--text-light);">×™×¦×™×¨×ª ×¡×™×¡××” ×—×“×©×”</p>
                <div class="form-group">
                    <label>××™××™×™×œ</label>
                    <input type="email" id="setupEmail" placeholder="office@neriyabudraham.co.il" required>
                </div>
                <div class="form-group">
                    <label>×¡×™×¡××” ×—×“×©×”</label>
                    <input type="password" id="setupPassword" minlength="6" required>
                </div>
                <div class="form-group">
                    <label>××™××•×ª ×¡×™×¡××”</label>
                    <input type="password" id="setupPasswordConfirm" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">×¦×•×¨ ×¡×™×¡××”</button>
            </form>
            
            <form id="loginForm" style="display: none;">
                <div class="form-group">
                    <label>××™××™×™×œ</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>×¡×™×¡××”</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">×”×ª×—×‘×¨</button>
                <div class="divider">××•</div>
                <a href="/admin/google-auth" class="btn btn-google">
                    <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
                    ×”×ª×—×‘×¨ ×¢× Google
                </a>
            </form>
            
            <div id="loadingLogin" class="loading"><div class="spinner"></div><p>×˜×•×¢×Ÿ...</p></div>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <header class="header">
            <h1>ğŸ“Š × ×™×”×•×œ ×©××™×¨×ª ×× ×©×™ ×§×©×¨</h1>
            <div class="header-actions">
                <span id="autoSaveStatus" style="font-size: 0.85rem; color: var(--success);">ğŸŸ¢ ×©××™×¨×” ××•×˜×•××˜×™×ª ×¤×¢×™×œ×”</span>
                <button onclick="loadData(); loadCampaigns();" class="btn btn-sm btn-primary">ğŸ”„ ×¨×¢× ×Ÿ</button>
                <button onclick="migrateTokens()" class="btn btn-sm btn-outline">ğŸ”’ ×”×¦×¤×Ÿ ×˜×•×§× ×™×</button>
                <button onclick="logout()" class="btn btn-sm btn-danger">×™×¦×™××”</button>
            </div>
        </header>
        
        <main class="main-content">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('customers')">ğŸ‘¥ ×œ×§×•×—×•×ª</button>
                <button class="tab" onclick="switchTab('campaigns')">ğŸ“ ×§××¤×™×™× ×™×</button>
                <button class="tab" onclick="switchTab('errors')">âš ï¸ ×©×’×™××•×ª</button>
            </div>
            
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>×œ×§×•×—×•×ª ×¤×¢×™×œ×™×</h3>
                    <div class="value primary" id="totalCustomers">-</div>
                </div>
                <div class="stat-card">
                    <h3>××—×•×‘×¨×™×</h3>
                    <div class="value success" id="connectedCustomers">-</div>
                </div>
                <div class="stat-card">
                    <h3>×¢× ×©×’×™××•×ª</h3>
                    <div class="value danger" id="errorCustomers">-</div>
                </div>
                <div class="stat-card">
                    <h3>×××ª×™× ×™×</h3>
                    <div class="value warning" id="totalPending">-</div>
                </div>
                <div class="stat-card">
                    <h3>× ×©××¨×• ×‘×©×¢×”</h3>
                    <div class="value success" id="lastHourSaved">-</div>
                </div>
                <div class="stat-card">
                    <h3>×¡×”"×› × ×©××¨×•</h3>
                    <div class="value primary" id="totalSaved">-</div>
                </div>
            </div>
            
            <!-- Customers Tab -->
            <div id="customersTab">
                <div class="filters">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©×, ×˜×œ×¤×•×Ÿ ××• ××™××™×™×œ..." oninput="filterCustomers()">
                    </div>
                    <select class="filter-select" id="sortSelect" onchange="sortCustomers()">
                        <option value="relevance">××™×•×Ÿ: ×¨×œ×•×•× ×˜×™×•×ª</option>
                        <option value="pending">××™×•×Ÿ: ×××ª×™× ×™× ×œ×©××™×¨×”</option>
                        <option value="saved">××™×•×Ÿ: × ×©××¨×•</option>
                        <option value="campaigns">××™×•×Ÿ: ××¡×¤×¨ ×§××¤×™×™× ×™×</option>
                        <option value="name">××™×•×Ÿ: ×©×</option>
                    </select>
                </div>
                <div id="customersGrid" class="customers-grid">
                    <div class="loading"><div class="spinner"></div><p>×˜×•×¢×Ÿ...</p></div>
                </div>
            </div>
            
            <!-- Campaigns Tab -->
            <div id="campaignsTab" style="display: none;">
                <div class="filters">
                    <div class="search-box">
                        <input type="text" id="campaignSearchInput" placeholder="×—×™×¤×•×© ×§××¤×™×™×Ÿ..." oninput="filterCampaigns()">
                    </div>
                </div>
                <div id="campaignsGrid" class="customers-grid">
                    <div class="loading"><div class="spinner"></div><p>×˜×•×¢×Ÿ...</p></div>
                </div>
            </div>
            
            <!-- Errors Tab -->
            <div id="errorsTab" style="display: none;">
                <div id="errorsGrid" class="customers-grid">
                    <div class="loading"><div class="spinner"></div><p>×˜×•×¢×Ÿ...</p></div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Customer Modal -->
    <div id="customerModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">×¤×¨×˜×™ ×œ×§×•×—</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading"><div class="spinner"></div><p>×˜×•×¢×Ÿ...</p></div>
            </div>
        </div>
    </div>
    
    <!-- Campaign Modal -->
    <div id="campaignModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="campaignModalTitle">×¤×¨×˜×™ ×§××¤×™×™×Ÿ</h2>
                <button class="modal-close" onclick="closeCampaignModal()">&times;</button>
            </div>
            <div class="modal-body" id="campaignModalBody">
                <div class="loading"><div class="spinner"></div><p>×˜×•×¢×Ÿ...</p></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/admin';
        let allCustomers = [];
        let allCampaigns = [];
        
        // Format campaign name (replace _ with space)
        function formatCampaignName(name) {
            return name ? name.replace(/_/g, ' ') : '';
        }
        
        // Format error type to Hebrew
        function formatErrorType(errorType) {
            const errorTypes = {
                'TOKEN_INVALID': 'ğŸ”‘ ×˜×•×§×Ÿ ×œ× ×ª×§×™×Ÿ',
                'PERMISSION_DENIED': 'ğŸš« ××™×Ÿ ×”×¨×©××”',
                'RATE_LIMIT': 'â±ï¸ ××’×‘×œ×ª ×§×¦×‘',
                'RATE_LIMIT_TEMPORARY': 'â±ï¸ ××’×‘×œ×ª ×§×¦×‘ ×–×× ×™×ª',
                'CONTACT_LIMIT_EXCEEDED': 'ğŸ“‡ ××’×‘×œ×ª ×× ×©×™ ×§×©×¨',
                'UNKNOWN_ERROR': 'âŒ ×©×’×™××”'
            };
            return errorTypes[errorType] || errorType || '×©×’×™××”';
        }
        
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error) showError(decodeURIComponent(error));
            
            try {
                const res = await fetch(`${API_BASE}/verify`, { credentials: 'include' });
                if (res.ok) { showDashboard(); return; }
            } catch (e) {}
            
            try {
                const res = await fetch(`${API_BASE}/setup-status`);
                const data = await res.json();
                document.getElementById('loadingLogin').style.display = 'none';
                if (data.hasPassword) {
                    document.getElementById('loginForm').style.display = 'block';
                } else {
                    document.getElementById('setupForm').style.display = 'block';
                }
            } catch (e) { showError('×©×’×™××” ×‘×˜×¢×™× ×”'); }
        }
        
        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('show');
        }
        
        function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboard').classList.add('active');
            loadData();
        }
        
        document.getElementById('setupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('setupEmail').value;
            const password = document.getElementById('setupPassword').value;
            const confirm = document.getElementById('setupPasswordConfirm').value;
            if (password !== confirm) { showError('×¡×™×¡×××•×ª ×œ× ×ª×•×××•×ª'); return; }
            
            const res = await fetch(`${API_BASE}/setup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            if (res.ok) {
                document.getElementById('setupForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
            } else {
                const data = await res.json();
                showError(data.error);
            }
        });
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const res = await fetch(`${API_BASE}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password }),
                credentials: 'include'
            });
            if (res.ok) { showDashboard(); }
            else { const data = await res.json(); showError(data.error); }
        });
        
        async function logout() {
            await fetch(`${API_BASE}/logout`, { method: 'POST', credentials: 'include' });
            location.reload();
        }
        
        let allErrors = [];
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('customersTab').style.display = tab === 'customers' ? 'block' : 'none';
            document.getElementById('campaignsTab').style.display = tab === 'campaigns' ? 'block' : 'none';
            document.getElementById('errorsTab').style.display = tab === 'errors' ? 'block' : 'none';
            
            if (tab === 'campaigns' && allCampaigns.length === 0) {
                loadCampaigns();
            }
            if (tab === 'errors') {
                loadErrors();
            }
        }
        
        async function loadErrors() {
            try {
                const res = await fetch(`${API_BASE}/customers-with-errors`, { credentials: 'include' });
                allErrors = await res.json();
                renderErrors(allErrors);
            } catch (e) { 
                console.error('Load errors:', e);
                document.getElementById('errorsGrid').innerHTML = '<div class="empty-state">×©×’×™××” ×‘×˜×¢×™× ×”</div>';
            }
        }
        
        function renderErrors(errors) {
            const grid = document.getElementById('errorsGrid');
            
            if (!errors || errors.length === 0) {
                grid.innerHTML = '<div class="empty-state">ğŸ‰ ××™×Ÿ ×œ×§×•×—×•×ª ×¢× ×©×’×™××•×ª!</div>';
                return;
            }
            
            grid.innerHTML = errors.map(c => `
                <div class="customer-card has-error" onclick="openCustomerDetail('${c.phone}')">
                    <div class="customer-card-header">
                        <div class="customer-info">
                            <h3>${c.full_name || '×œ×œ× ×©×'}</h3>
                            <div class="phone">${c.phone || '-'}</div>
                        </div>
                        <div class="customer-status">
                            ${c.google_contact_count !== null ? `<span class="badge" style="background: #e0e7ff; color: #3730a3;">ğŸ“‡ ${c.google_contact_count}</span>` : ''}
                        </div>
                    </div>
                    <div class="error-banner">
                        <strong>${formatErrorType(c.last_error_type)}</strong>
                        <div style="font-size: 0.8rem; margin-top: 2px;">${c.last_error}</div>
                    </div>
                    <div style="padding: 0.75rem 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        ${['TOKEN_INVALID', 'PERMISSION_DENIED'].includes(c.last_error_type) ? `
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); copyReconnectLink('${c.phone}')" style="font-size: 0.75rem;">ğŸ“‹ ×”×¢×ª×§ ×§×™×©×•×¨</button>
                            <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); sendReconnectLink('${c.phone}')" style="font-size: 0.75rem;">ğŸ“± ×©×œ×— ×œ×œ×§×•×—</button>
                        ` : ''}
                    </div>
                    <div class="customer-card-footer">
                        <span>${c.email || '-'}</span>
                        <span style="font-size: 0.75rem;">${c.updated_at ? new Date(c.updated_at).toLocaleString('he-IL') : ''}</span>
                    </div>
                </div>
            `).join('');
        }
        
        async function loadData() {
            try {
                // Show refreshing indicator
                const statusEl = document.getElementById('autoSaveStatus');
                if (statusEl) statusEl.textContent = 'ğŸ”„ ××¨×¢× ×Ÿ...';
                
                const statusRes = await fetch(`${API_BASE}/status`, { credentials: 'include' });
                if (!statusRes.ok) { if (statusRes.status === 401) location.reload(); return; }
                const status = await statusRes.json();
                
                document.getElementById('totalCustomers').textContent = status.total_customers || 0;
                document.getElementById('connectedCustomers').textContent = status.connected_customers || 0;
                document.getElementById('errorCustomers').textContent = status.customers_with_errors || 0;
                document.getElementById('totalPending').textContent = Number(status.total_pending || 0).toLocaleString();
                document.getElementById('lastHourSaved').textContent = status.last_hour_saved || 0;
                document.getElementById('totalSaved').textContent = Number(status.total_saved || 0).toLocaleString();
                
                const customersRes = await fetch(`${API_BASE}/customers`, { credentials: 'include' });
                allCustomers = await customersRes.json();
                renderCustomers(allCustomers);
                
                // Update refresh timestamp
                const time = new Date().toLocaleTimeString('he-IL');
                if (statusEl) statusEl.textContent = `ğŸŸ¢ ×¢×•×“×›×Ÿ: ${time}`;
            } catch (e) { 
                console.error('Load error:', e);
                const statusEl = document.getElementById('autoSaveStatus');
                if (statusEl) statusEl.textContent = 'ğŸ”´ ×©×’×™××” ×‘×˜×¢×™× ×”';
            }
        }
        
        async function loadCampaigns() {
            try {
                const res = await fetch(`${API_BASE}/campaigns`, { credentials: 'include' });
                allCampaigns = await res.json();
                renderCampaigns(allCampaigns);
            } catch (e) { console.error('Load campaigns error:', e); }
        }
        
        function filterCustomers() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allCustomers.filter(c => 
                (c.full_name || '').toLowerCase().includes(search) ||
                (c.phone || '').includes(search) ||
                (c.email || '').toLowerCase().includes(search)
            );
            renderCustomers(filtered);
        }
        
        function sortCustomers() {
            const sort = document.getElementById('sortSelect').value;
            let sorted = [...allCustomers];
            
            switch(sort) {
                case 'pending':
                    sorted.sort((a, b) => Number(b.total_pending || 0) - Number(a.total_pending || 0));
                    break;
                case 'saved':
                    sorted.sort((a, b) => Number(b.total_saved || 0) - Number(a.total_saved || 0));
                    break;
                case 'campaigns':
                    sorted.sort((a, b) => Number(b.campaign_count || 0) - Number(a.campaign_count || 0));
                    break;
                case 'name':
                    sorted.sort((a, b) => (a.full_name || '').localeCompare(b.full_name || ''));
                    break;
            }
            renderCustomers(sorted);
        }
        
        function filterCampaigns() {
            const search = document.getElementById('campaignSearchInput').value.toLowerCase();
            const filtered = allCampaigns.filter(c => 
                formatCampaignName(c.campaign_name).toLowerCase().includes(search)
            );
            renderCampaigns(filtered);
        }
        
        function renderCustomers(customers) {
            const grid = document.getElementById('customersGrid');
            
            if (!customers || customers.length === 0) {
                grid.innerHTML = '<div class="empty-state">××™×Ÿ ×œ×§×•×—×•×ª ×œ×”×¦×’×”</div>';
                return;
            }
            
            grid.innerHTML = customers.map(c => `
                <div class="customer-card ${c.last_error ? 'has-error' : ''}" onclick="openCustomerDetail('${c.phone}')">
                    <div class="customer-card-header">
                        <div class="customer-info">
                            <h3>${c.full_name || '×œ×œ× ×©×'}</h3>
                            <div class="phone">${c.phone || '-'}</div>
                        </div>
                        <div class="customer-status">
                            ${c.has_valid_tokens ? '<span class="badge badge-success">××—×•×‘×¨</span>' : '<span class="badge badge-warning">×œ× ××—×•×‘×¨</span>'}
                            ${c.google_contact_count !== null && c.google_contact_count !== undefined ? `<span class="badge" style="background: #e0e7ff; color: #3730a3;">ğŸ“‡ ${c.google_contact_count}</span>` : ''}
                        </div>
                    </div>
                    ${c.last_error ? `
                    <div class="error-banner">
                        <strong>âš ï¸ ${formatErrorType(c.last_error_type)}</strong>
                        <div style="font-size: 0.8rem; margin-top: 2px;">${c.last_error}</div>
                    </div>
                    ` : ''}
                    <div class="customer-card-stats">
                        <div class="mini-stat">
                            <div class="label">×§××¤×™×™× ×™×</div>
                            <div class="value" style="color: var(--primary)">${c.campaign_count || 0}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">×××ª×™× ×™×</div>
                            <div class="value" style="color: var(--warning)">${Number(c.total_pending || 0).toLocaleString()}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">× ×©××¨×•</div>
                            <div class="value" style="color: var(--success)">${Number(c.total_saved || 0).toLocaleString()}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">×§×™×™××™×</div>
                            <div class="value" style="color: var(--text-light)">${Number(c.total_existed || 0).toLocaleString()}</div>
                        </div>
                        ${c.total_skipped > 0 ? `
                        <div class="mini-stat">
                            <div class="label">×œ× ×œ×©××™×¨×”</div>
                            <div class="value" style="color: var(--danger)">${Number(c.total_skipped).toLocaleString()}</div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="customer-card-footer">
                        <span>${c.email || '-'}</span>
                        ${c.last_hour_saved > 0 ? `<span class="last-hour-badge">+${c.last_hour_saved} ×‘×©×¢×”</span>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function renderCampaigns(campaigns) {
            const grid = document.getElementById('campaignsGrid');
            
            if (!campaigns || campaigns.length === 0) {
                grid.innerHTML = '<div class="empty-state">××™×Ÿ ×§××¤×™×™× ×™× ×œ×”×¦×’×”</div>';
                return;
            }
            
            grid.innerHTML = campaigns.map(c => `
                <div class="campaign-card" onclick="openCampaignDetail('${encodeURIComponent(c.campaign_name)}')">
                    <h3>ğŸ“ ${formatCampaignName(c.campaign_name)}</h3>
                    <div class="campaign-stats">
                        <div class="stat">
                            <div class="label">×œ×§×•×—×•×ª</div>
                            <div class="value" style="color: var(--primary)">${c.customer_count}</div>
                        </div>
                        <div class="stat">
                            <div class="label">×××ª×™× ×™×</div>
                            <div class="value" style="color: var(--warning)">${Number(c.total_pending || 0).toLocaleString()}</div>
                        </div>
                        <div class="stat">
                            <div class="label">× ×©××¨×•</div>
                            <div class="value" style="color: var(--success)">${Number(c.total_saved || 0).toLocaleString()}</div>
                        </div>
                        <div class="stat">
                            <div class="label">×§×™×™××™×</div>
                            <div class="value">${Number(c.total_existed || 0).toLocaleString()}</div>
                        </div>
                        ${c.total_skipped > 0 ? `
                        <div class="stat">
                            <div class="label">×œ× ×œ×©××™×¨×”</div>
                            <div class="value" style="color: var(--danger)">${Number(c.total_skipped).toLocaleString()}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        async function openCustomerDetail(phone) {
            document.getElementById('customerModal').classList.add('active');
            document.getElementById('modalBody').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const res = await fetch(`${API_BASE}/customers/${phone}`, { credentials: 'include' });
                const data = await res.json();
                if (!res.ok) { document.getElementById('modalBody').innerHTML = `<p>×©×’×™××”: ${data.error}</p>`; return; }
                renderCustomerDetail(data);
            } catch (e) { document.getElementById('modalBody').innerHTML = '<p>×©×’×™××” ×‘×˜×¢×™× ×”</p>'; }
        }
        
        function renderCustomerDetail(data) {
            const { customer, campaigns, summary, recentActivity } = data;
            document.getElementById('modalTitle').textContent = customer.full_name || customer.phone;
            
            let html = '';
            
            // Customer info header
            html += `
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    ${customer.google_contact_count !== null && customer.google_contact_count !== undefined ? 
                        `<div class="badge" style="background: #e0e7ff; color: #3730a3; font-size: 1rem; padding: 0.5rem 1rem;">
                            ğŸ“‡ ${customer.google_contact_count} ×× ×©×™ ×§×©×¨ ×‘×—×©×‘×•×Ÿ
                        </div>` : ''
                    }
                    ${customer.has_valid_tokens ? 
                        '<span class="badge badge-success" style="font-size: 0.9rem;">âœ… ××—×•×‘×¨</span>' : 
                        '<span class="badge badge-warning" style="font-size: 0.9rem;">âŒ ×œ× ××—×•×‘×¨</span>'
                    }
                </div>
            `;
            
            // Error alert with details and reconnection buttons
            if (customer.last_error) {
                const needsReconnect = ['TOKEN_INVALID', 'PERMISSION_DENIED'].includes(customer.last_error_type);
                const needsNewAccount = ['CONTACT_LIMIT_EXCEEDED', 'CONTACT_LIMIT_MAX'].includes(customer.last_error_type);
                
                html += `
                    <div class="error-alert" style="background: #fef2f2; border: 2px solid var(--danger); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="font-size: 1.1rem; font-weight: 600; color: var(--danger); margin-bottom: 0.5rem;">
                            ${formatErrorType(customer.last_error_type)}
                        </div>
                        <div style="color: #991b1b; margin-bottom: 1rem;">${customer.last_error}</div>
                        
                        ${needsReconnect ? `
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-sm btn-primary" onclick="copyReconnectLink('${customer.phone}')">
                                ğŸ“‹ ×”×¢×ª×§ ×§×™×©×•×¨ ×”×ª×—×‘×¨×•×ª
                            </button>
                            <button class="btn btn-sm btn-success" onclick="sendReconnectLink('${customer.phone}')">
                                ğŸ“± ×©×œ×— ×§×™×©×•×¨ ×œ×œ×§×•×—
                            </button>
                        </div>
                        ` : ''}
                        
                        ${needsNewAccount ? `
                        <div style="padding: 0.5rem; background: #fef3c7; border-radius: 4px; color: #92400e;">
                            âš ï¸ ×™×© ×œ×—×‘×¨ ×—×©×‘×•×Ÿ ×’×•×’×œ ×—×“×© ××• ×œ××—×•×§ ×× ×©×™ ×§×©×¨ ××”×—×©×‘×•×Ÿ ×”×§×™×™×
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Summary
            html += `
                <div class="detail-summary">
                    <div class="detail-stat">
                        <div class="label">×¡×”"×›</div>
                        <div class="value" style="color: var(--primary)">${Number(summary.total_contacts).toLocaleString()}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="label">×××ª×™× ×™×</div>
                        <div class="value" style="color: var(--warning)">${Number(summary.total_pending).toLocaleString()}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="label">× ×©××¨×•</div>
                        <div class="value" style="color: var(--success)">${Number(summary.total_saved).toLocaleString()}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="label">×§×™×™××™×</div>
                        <div class="value">${Number(summary.total_existed).toLocaleString()}</div>
                    </div>
                    ${summary.total_skipped > 0 ? `
                    <div class="detail-stat">
                        <div class="label">×œ× ×œ×©××™×¨×”</div>
                        <div class="value" style="color: var(--danger)">${Number(summary.total_skipped).toLocaleString()}</div>
                    </div>
                    ` : ''}
                    <div class="detail-stat">
                        <div class="label">×‘×©×¢×”</div>
                        <div class="value" style="color: var(--success)">${summary.last_hour_saved}</div>
                    </div>
                </div>
            `;
            
            // Action buttons for all pending contacts
            if (summary.total_pending > 0) {
                html += `
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin: 1.5rem 0; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                        <h4 style="width: 100%; margin-bottom: 0.5rem;">âš¡ ×¤×¢×•×œ×•×ª ×¢×œ ${Number(summary.total_pending).toLocaleString()} ×× ×©×™ ×§×©×¨ ×××ª×™× ×™×:</h4>
                        <button class="btn btn-primary btn-sm" onclick="downloadCustomerVCF('${customer.phone}')">
                            ğŸ“¥ ×”×•×¨×“ VCF
                        </button>
                        <button class="btn btn-success btn-sm" onclick="markCustomerSaved('${customer.phone}')">
                            âœ… ×¡××Ÿ ×›× ×©××¨×•
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="markCustomerNotSaving('${customer.phone}')">
                            âŒ ×¡××Ÿ ×›×œ× ×œ×©××™×¨×”
                        </button>
                    </div>
                `;
            }
            
            // Campaigns table
            if (campaigns && campaigns.length > 0) {
                html += `
                    <h3 style="margin: 1.5rem 0 1rem;">ğŸ“ ×§××¤×™×™× ×™×</h3>
                    <table class="campaign-table">
                        <thead>
                            <tr>
                                <th>×§××¤×™×™×Ÿ</th>
                                <th>×¡×”"×›</th>
                                <th>×××ª×™× ×™×</th>
                                <th>× ×©××¨×•</th>
                                <th>×§×™×™××™×</th>
                                <th>×œ× ×œ×©××™×¨×”</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${campaigns.map(c => `
                                <tr>
                                    <td><strong>${formatCampaignName(c.campaign_name)}</strong></td>
                                    <td>${c.total_contacts}</td>
                                    <td style="color: var(--warning)">${c.pending_count}</td>
                                    <td style="color: var(--success)">${c.saved_count}</td>
                                    <td>${c.existed_count}</td>
                                    <td style="color: var(--danger)">${c.skipped_count || 0}</td>
                                    <td style="white-space: nowrap;">
                                        ${c.pending_count > 0 ? `
                                            <button class="btn btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="event.stopPropagation(); downloadCampaignVCF('${customer.phone}', '${encodeURIComponent(c.campaign_name)}')">ğŸ“¥</button>
                                            <button class="btn btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: var(--success); color: white;" onclick="event.stopPropagation(); markCampaignSaved('${customer.phone}', '${encodeURIComponent(c.campaign_name)}')">âœ…</button>
                                            <button class="btn btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: var(--danger); color: white;" onclick="event.stopPropagation(); markCampaignNotSaving('${customer.phone}', '${encodeURIComponent(c.campaign_name)}')">âŒ</button>
                                        ` : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            // Recent activity
            if (recentActivity && recentActivity.length > 0) {
                html += `
                    <h3 style="margin: 1.5rem 0 1rem;">ğŸ“‹ ×¤×¢×™×œ×•×ª ××—×¨×•× ×”</h3>
                    <table class="campaign-table">
                        <thead>
                            <tr><th>×©× ××§×•×¨×™</th><th>×©× ×©× ×©××¨</th><th>×˜×œ×¤×•×Ÿ</th><th>×§××¤×™×™×Ÿ</th><th>×¡×˜×˜×•×¡</th><th>×–××Ÿ</th></tr>
                        </thead>
                        <tbody>
                            ${recentActivity.slice(0, 15).map(a => `
                                <tr>
                                    <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis;">${a.contact_name || '-'}</td>
                                    <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; ${a.saved_name && a.saved_name !== a.contact_name ? 'color: var(--success); font-weight: 600;' : ''}">
                                        ${a.saved_name || a.contact_name || '-'}
                                        ${a.saved_name && a.saved_name !== a.contact_name ? ' âœ“' : ''}
                                    </td>
                                    <td dir="ltr">${a.contact_phone}</td>
                                    <td style="font-size: 0.85rem">${formatCampaignName(a.campaign_name)}</td>
                                    <td>
                                        <span class="badge ${a.status === 'saved' ? 'badge-success' : a.status === 'existed' ? 'badge-warning' : a.status === 'error' ? 'badge-danger' : ''}">
                                            ${a.status === 'saved' ? '× ×©××¨' : a.status === 'existed' ? '×§×™×™×' : a.status === 'error' ? '×©×’×™××”' : a.status}
                                        </span>
                                        ${a.status === 'error' && a.error_message ? `<div style="font-size: 0.75rem; color: var(--danger); margin-top: 2px;">${a.error_message}</div>` : ''}
                                    </td>
                                    <td style="font-size: 0.8rem">${a.processed_at ? new Date(a.processed_at).toLocaleString('he-IL') : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            document.getElementById('modalBody').innerHTML = html;
        }
        
        async function openCampaignDetail(encodedName) {
            document.getElementById('campaignModal').classList.add('active');
            document.getElementById('campaignModalBody').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const res = await fetch(`${API_BASE}/campaigns/${encodedName}`, { credentials: 'include' });
                const data = await res.json();
                if (!res.ok) { document.getElementById('campaignModalBody').innerHTML = `<p>×©×’×™××”</p>`; return; }
                renderCampaignDetail(data);
            } catch (e) { document.getElementById('campaignModalBody').innerHTML = '<p>×©×’×™××” ×‘×˜×¢×™× ×”</p>'; }
        }
        
        function renderCampaignDetail(data) {
            const { campaign_name, customers, summary } = data;
            document.getElementById('campaignModalTitle').textContent = formatCampaignName(campaign_name);
            
            let html = `
                <div class="detail-summary">
                    <div class="detail-stat">
                        <div class="label">×œ×§×•×—×•×ª</div>
                        <div class="value" style="color: var(--primary)">${summary.total_customers}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="label">×¡×”"×›</div>
                        <div class="value">${Number(summary.total_contacts).toLocaleString()}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="label">×××ª×™× ×™×</div>
                        <div class="value" style="color: var(--warning)">${Number(summary.total_pending).toLocaleString()}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="label">× ×©××¨×•</div>
                        <div class="value" style="color: var(--success)">${Number(summary.total_saved).toLocaleString()}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="label">×§×™×™××™×</div>
                        <div class="value">${Number(summary.total_existed).toLocaleString()}</div>
                    </div>
                    ${summary.total_skipped > 0 ? `
                    <div class="detail-stat">
                        <div class="label">×œ× ×œ×©××™×¨×”</div>
                        <div class="value" style="color: var(--danger)">${Number(summary.total_skipped).toLocaleString()}</div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            if (customers && customers.length > 0) {
                html += `
                    <h3 style="margin: 1.5rem 0 1rem;">ğŸ‘¥ ×œ×§×•×—×•×ª ×‘×§××¤×™×™×Ÿ</h3>
                    <table class="campaign-table">
                        <thead>
                            <tr>
                                <th>×©×</th>
                                <th>×˜×œ×¤×•×Ÿ</th>
                                <th>×¡×˜×˜×•×¡</th>
                                <th>×××ª×™× ×™×</th>
                                <th>× ×©××¨×•</th>
                                <th>×§×™×™××™×</th>
                                <th>×œ× ×œ×©××™×¨×”</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customers.map(c => `
                                <tr onclick="closeModals(); openCustomerDetail('${c.customer_phone}')" style="cursor: pointer;">
                                    <td><strong>${c.full_name || '×œ×œ× ×©×'}</strong></td>
                                    <td dir="ltr">${c.customer_phone}</td>
                                    <td>
                                        ${c.has_valid_tokens ? '<span class="badge badge-success">××—×•×‘×¨</span>' : '<span class="badge badge-warning">×œ× ××—×•×‘×¨</span>'}
                                        ${c.last_error ? '<span class="badge badge-danger">×©×’×™××”</span>' : ''}
                                    </td>
                                    <td style="color: var(--warning)">${c.pending_count}</td>
                                    <td style="color: var(--success)">${c.saved_count}</td>
                                    <td>${c.existed_count}</td>
                                    <td style="color: var(--danger)">${c.skipped_count || 0}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            document.getElementById('campaignModalBody').innerHTML = html;
        }
        
        function closeModal() { document.getElementById('customerModal').classList.remove('active'); }
        function closeCampaignModal() { document.getElementById('campaignModal').classList.remove('active'); }
        function closeModals() { closeModal(); closeCampaignModal(); }
        
        document.getElementById('customerModal').addEventListener('click', (e) => { if (e.target.id === 'customerModal') closeModal(); });
        document.getElementById('campaignModal').addEventListener('click', (e) => { if (e.target.id === 'campaignModal') closeCampaignModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModals(); });
        
        async function migrateTokens() {
            if (!confirm('×œ×”×¦×¤×™×Ÿ ××ª ×›×œ ×”×˜×•×§× ×™×?')) return;
            const res = await fetch(`${API_BASE}/migrate-tokens`, { method: 'POST', credentials: 'include' });
            const data = await res.json();
            alert(res.ok ? `×”×•×¦×¤× ×•: ${data.migrated}, ×›×‘×¨ ××•×¦×¤× ×™×: ${data.skipped}` : '×©×’×™××”');
        }

        // ==================== VCF DOWNLOAD & CONTACT MANAGEMENT ====================
        
        // Download VCF for all pending contacts of a customer
        async function downloadCustomerVCF(phone) {
            try {
                window.location.href = `${API_BASE}/customers/${phone}/download-vcf`;
                setTimeout(() => {
                    showAfterDownloadDialog(phone, null);
                }, 1000);
            } catch (e) {
                alert('×©×’×™××” ×‘×”×•×¨×“×”');
            }
        }
        
        // Download VCF for a specific campaign
        async function downloadCampaignVCF(phone, campaignName) {
            try {
                window.location.href = `${API_BASE}/campaigns/${campaignName}/customers/${phone}/download-vcf`;
                setTimeout(() => {
                    showAfterDownloadDialog(phone, campaignName);
                }, 1000);
            } catch (e) {
                alert('×©×’×™××” ×‘×”×•×¨×“×”');
            }
        }
        
        // Show dialog after VCF download
        function showAfterDownloadDialog(phone, campaignName) {
            const scope = campaignName ? `×§××¤×™×™×Ÿ ${formatCampaignName(decodeURIComponent(campaignName))}` : '×›×œ ×”×§××¤×™×™× ×™×';
            const result = confirm(`×”×§×•×‘×¥ ×”×•×¨×“!\n\n×œ××—×¨ ×™×™×‘×•× ×× ×©×™ ×”×§×©×¨, ××” ×œ×¢×©×•×ª ×¢× ×”×¨×©×™××”?\n\nâœ… OK = ×¡××Ÿ ×›× ×©××¨×•\nâŒ Cancel = ×‘×˜×œ (×œ×œ× ×©×™× ×•×™)`);
            
            if (result) {
                if (campaignName) {
                    markCampaignSaved(phone, campaignName);
                } else {
                    markCustomerSaved(phone);
                }
            }
        }
        
        // Mark all pending contacts as saved for a customer
        async function markCustomerSaved(phone) {
            if (!confirm('×œ×¡××Ÿ ××ª ×›×œ ×× ×©×™ ×”×§×©×¨ ×”×××ª×™× ×™× ×›× ×©××¨×•?')) return;
            try {
                const res = await fetch(`${API_BASE}/customers/${phone}/mark-saved`, { method: 'POST', credentials: 'include' });
                const data = await res.json();
                alert(res.ok ? `×¡×•×× ×• ${data.marked} ×× ×©×™ ×§×©×¨ ×›× ×©××¨×•` : '×©×’×™××”');
                loadData();
                openCustomerDetail(phone);
            } catch (e) {
                alert('×©×’×™××”');
            }
        }
        
        // Mark all pending contacts as not saving for a customer
        async function markCustomerNotSaving(phone) {
            if (!confirm('×œ×¡××Ÿ ××ª ×›×œ ×× ×©×™ ×”×§×©×¨ ×”×××ª×™× ×™× ×›"×œ× ×œ×©××™×¨×”"?')) return;
            try {
                const res = await fetch(`${API_BASE}/customers/${phone}/mark-not-saving`, { method: 'POST', credentials: 'include' });
                const data = await res.json();
                alert(res.ok ? `×¡×•×× ×• ${data.marked} ×× ×©×™ ×§×©×¨ ×›×œ× ×œ×©××™×¨×”` : '×©×’×™××”');
                loadData();
                openCustomerDetail(phone);
            } catch (e) {
                alert('×©×’×™××”');
            }
        }
        
        // Mark campaign contacts as saved
        async function markCampaignSaved(phone, campaignName) {
            try {
                const res = await fetch(`${API_BASE}/campaigns/${campaignName}/customers/${phone}/mark-saved`, { method: 'POST', credentials: 'include' });
                const data = await res.json();
                alert(res.ok ? `×¡×•×× ×• ${data.marked} ×× ×©×™ ×§×©×¨ ×›× ×©××¨×•` : '×©×’×™××”');
                loadData();
                openCustomerDetail(phone);
            } catch (e) {
                alert('×©×’×™××”');
            }
        }
        
        // Mark campaign contacts as not saving
        async function markCampaignNotSaving(phone, campaignName) {
            if (!confirm('×œ×¡××Ÿ ××ª ×× ×©×™ ×”×§×©×¨ ×‘×§××¤×™×™×Ÿ ×”×–×” ×›"×œ× ×œ×©××™×¨×”"?')) return;
            try {
                const res = await fetch(`${API_BASE}/campaigns/${campaignName}/customers/${phone}/mark-not-saving`, { method: 'POST', credentials: 'include' });
                const data = await res.json();
                alert(res.ok ? `×¡×•×× ×• ${data.marked} ×× ×©×™ ×§×©×¨ ×›×œ× ×œ×©××™×¨×”` : '×©×’×™××”');
                loadData();
                openCustomerDetail(phone);
            } catch (e) {
                alert('×©×’×™××”');
            }
        }

        // ==================== RECONNECTION LINKS ====================
        
        // Copy reconnection link to clipboard
        async function copyReconnectLink(phone) {
            try {
                const res = await fetch(`${API_BASE}/customers/${phone}/reconnect-link`, { credentials: 'include' });
                const data = await res.json();
                
                if (!res.ok) {
                    alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×§×™×©×•×¨');
                    return;
                }
                
                await navigator.clipboard.writeText(data.link);
                alert('×”×§×™×©×•×¨ ×”×•×¢×ª×§ ×œ×œ×•×—!\n\n' + data.link);
            } catch (e) {
                alert('×©×’×™××” ×‘×”×¢×ª×§×ª ×”×§×™×©×•×¨');
            }
        }
        
        // Send reconnection link via WhatsApp
        async function sendReconnectLink(phone) {
            if (!confirm('×œ×©×œ×•×— ×§×™×©×•×¨ ×”×ª×—×‘×¨×•×ª ×œ×œ×§×•×— ×‘×•×•××˜×¡××¤?')) return;
            try {
                const res = await fetch(`${API_BASE}/customers/${phone}/send-reconnect`, { 
                    method: 'POST', 
                    credentials: 'include' 
                });
                const data = await res.json();
                
                alert(res.ok ? '×”×§×™×©×•×¨ × ×©×œ×— ×‘×”×¦×œ×—×”!' : '×©×’×™××” ×‘×©×œ×™×—×”: ' + (data.error || '×œ× ×™×“×•×¢'));
            } catch (e) {
                alert('×©×’×™××” ×‘×©×œ×™×—×”');
            }
        }
        
        // Auto-refresh every 10 seconds for real-time data
        setInterval(() => {
            if (document.getElementById('dashboard').classList.contains('active')) loadData();
        }, 10000);
        
        init();
    </script>
</body>
</html>
