<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×©××™×¨×ª ×× ×©×™ ×§×©×¨ - Botomat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-hover: #3a56d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #1f2937;
            --text-light: #6b7280;
            --bg: #f3f4f6;
            --white: #ffffff;
            --border: #e5e7eb;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Heebo', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        
        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
        }
        
        .login-card h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1.75rem;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-block { width: 100%; }
        
        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
        }
        
        .btn-google {
            background: var(--white);
            border: 2px solid var(--border);
            color: var(--text);
            margin-top: 1rem;
            width: 100%;
        }
        
        .btn-google:hover {
            background: var(--bg);
        }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }
        
        .divider::before { margin-left: 1rem; }
        .divider::after { margin-right: 1rem; }
        
        .error-msg {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.95rem;
            display: none;
        }
        
        .error-msg.show { display: block; }
        
        /* Dashboard */
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .login-page.hidden { display: none; }
        
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text);
        }
        
        .btn-outline:hover {
            background: var(--bg);
        }
        
        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }
        
        .btn-success {
            background: var(--success);
            color: var(--white);
        }
        
        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: var(--shadow);
        }
        
        .stat-card h3 {
            color: var(--text-light);
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 1.75rem;
            font-weight: 700;
        }
        
        .stat-card .value.primary { color: var(--primary); }
        .stat-card .value.success { color: var(--success); }
        .stat-card .value.warning { color: var(--warning); }
        .stat-card .value.danger { color: var(--danger); }
        
        /* Customer Cards */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        
        .section-header h2 {
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .customers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        
        .customer-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .customer-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .customer-card-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .customer-info h3 {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }
        
        .customer-info .phone {
            color: var(--text-light);
            font-size: 0.9rem;
            direction: ltr;
            text-align: right;
        }
        
        .customer-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .customer-card-stats {
            padding: 1.25rem;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            text-align: center;
        }
        
        .mini-stat {
            padding: 0.5rem;
        }
        
        .mini-stat .label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        
        .mini-stat .value {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .customer-card-footer {
            padding: 1rem 1.25rem;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .last-hour-badge {
            background: var(--success);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* Customer Detail Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--white);
            border-radius: var(--radius);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0.5rem;
        }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .detail-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .detail-stat {
            background: var(--bg);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }
        
        .detail-stat .label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }
        
        .detail-stat .value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .campaigns-section h3 {
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .campaign-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }
        
        .campaign-table th,
        .campaign-table td {
            padding: 0.875rem 1rem;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }
        
        .campaign-table th {
            background: var(--bg);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .campaign-table tr:hover td {
            background: rgba(67, 97, 238, 0.05);
        }
        
        .error-alert {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .error-alert .icon {
            font-size: 1.5rem;
        }
        
        .error-alert .text {
            flex: 1;
        }
        
        .error-alert .type {
            font-weight: 600;
            color: var(--danger);
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .customers-grid {
                grid-template-columns: 1fr;
            }
            
            .modal {
                max-height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container login-page">
        <div class="login-card">
            <h1>ğŸ” ×›× ×™×¡×ª ×× ×”×œ</h1>
            
            <div id="errorMsg" class="error-msg"></div>
            
            <form id="setupForm" style="display: none;">
                <p style="margin-bottom: 1.5rem; color: var(--text-light);">×™×¦×™×¨×ª ×¡×™×¡××” ×—×“×©×” ×œ××¢×¨×›×ª</p>
                <div class="form-group">
                    <label>××™××™×™×œ</label>
                    <input type="email" id="setupEmail" placeholder="office@neriyabudraham.co.il" required>
                </div>
                <div class="form-group">
                    <label>×¡×™×¡××” ×—×“×©×”</label>
                    <input type="password" id="setupPassword" placeholder="×œ×¤×—×•×ª 6 ×ª×•×•×™×" minlength="6" required>
                </div>
                <div class="form-group">
                    <label>××™××•×ª ×¡×™×¡××”</label>
                    <input type="password" id="setupPasswordConfirm" placeholder="×”×§×œ×“ ×©×•×‘" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">×¦×•×¨ ×¡×™×¡××”</button>
            </form>
            
            <form id="loginForm" style="display: none;">
                <div class="form-group">
                    <label>××™××™×™×œ</label>
                    <input type="email" id="loginEmail" placeholder="office@neriyabudraham.co.il" required>
                </div>
                <div class="form-group">
                    <label>×¡×™×¡××”</label>
                    <input type="password" id="loginPassword" placeholder="×”×›× ×¡ ×¡×™×¡××”" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">×”×ª×—×‘×¨</button>
                
                <div class="divider">××•</div>
                
                <a href="/admin/google-auth" class="btn btn-google">
                    <svg width="20" height="20" viewBox="0 0 48 48">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                    </svg>
                    ×”×ª×—×‘×¨ ×¢× Google
                </a>
            </form>
            
            <div id="loadingLogin" class="loading">
                <div class="spinner"></div>
                <p>×˜×•×¢×Ÿ...</p>
            </div>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <header class="header">
            <h1>ğŸ“Š ×œ×•×— ×‘×§×¨×” - ×©××™×¨×ª ×× ×©×™ ×§×©×¨</h1>
            <div class="header-actions">
                <button onclick="runSaver()" class="btn btn-sm btn-success">â–¶ ×”×¤×¢×œ ×©××™×¨×”</button>
                <button onclick="migrateTokens()" class="btn btn-sm btn-outline">ğŸ”’ ×”×¦×¤×Ÿ ×˜×•×§× ×™×</button>
                <button onclick="logout()" class="btn btn-sm btn-danger">×™×¦×™××”</button>
            </div>
        </header>
        
        <main class="main-content">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>×¡×”"×› ×œ×§×•×—×•×ª</h3>
                    <div class="value primary" id="totalCustomers">-</div>
                </div>
                <div class="stat-card">
                    <h3>×œ×§×•×—×•×ª ××—×•×‘×¨×™×</h3>
                    <div class="value success" id="connectedCustomers">-</div>
                </div>
                <div class="stat-card">
                    <h3>×œ×§×•×—×•×ª ×¢× ×©×’×™××•×ª</h3>
                    <div class="value danger" id="errorCustomers">-</div>
                </div>
                <div class="stat-card">
                    <h3>×××ª×™× ×™× ×œ×©××™×¨×”</h3>
                    <div class="value warning" id="totalPending">-</div>
                </div>
                <div class="stat-card">
                    <h3>× ×©××¨×• ×‘×©×¢×” ×”××—×¨×•× ×”</h3>
                    <div class="value success" id="lastHourSaved">-</div>
                </div>
                <div class="stat-card">
                    <h3>×¡×”"×› × ×©××¨×•</h3>
                    <div class="value primary" id="totalSaved">-</div>
                </div>
            </div>
            
            <!-- Customers -->
            <div class="section-header">
                <h2>ğŸ‘¥ ×œ×§×•×—×•×ª</h2>
                <button onclick="loadData()" class="btn btn-sm btn-outline">ğŸ”„ ×¨×¢× ×Ÿ</button>
            </div>
            
            <div id="customersGrid" class="customers-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>×˜×•×¢×Ÿ ×œ×§×•×—×•×ª...</p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Customer Detail Modal -->
    <div id="customerModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">×¤×¨×˜×™ ×œ×§×•×—</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>×˜×•×¢×Ÿ ×¤×¨×˜×™×...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/admin';
        
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error) showError(decodeURIComponent(error));
            
            try {
                const res = await fetch(`${API_BASE}/verify`, { credentials: 'include' });
                if (res.ok) {
                    showDashboard();
                    return;
                }
            } catch (e) {}
            
            try {
                const res = await fetch(`${API_BASE}/setup-status`);
                const data = await res.json();
                
                document.getElementById('loadingLogin').style.display = 'none';
                
                if (data.hasPassword) {
                    document.getElementById('loginForm').style.display = 'block';
                } else {
                    document.getElementById('setupForm').style.display = 'block';
                }
            } catch (e) {
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×£');
            }
        }
        
        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('show');
        }
        
        function hideError() {
            document.getElementById('errorMsg').classList.remove('show');
        }
        
        function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboard').classList.add('active');
            loadData();
        }
        
        document.getElementById('setupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();
            
            const email = document.getElementById('setupEmail').value;
            const password = document.getElementById('setupPassword').value;
            const confirm = document.getElementById('setupPasswordConfirm').value;
            
            if (password !== confirm) {
                showError('×”×¡×™×¡×××•×ª ×œ× ×ª×•×××•×ª');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/setup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                if (!res.ok) {
                    showError(data.error);
                    return;
                }
                
                document.getElementById('setupForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('loginEmail').value = email;
            } catch (e) {
                showError('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¡×™×¡××”');
            }
        });
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const res = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include'
                });
                
                const data = await res.json();
                if (!res.ok) {
                    showError(data.error);
                    return;
                }
                
                showDashboard();
            } catch (e) {
                showError('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª');
            }
        });
        
        async function logout() {
            await fetch(`${API_BASE}/logout`, { method: 'POST', credentials: 'include' });
            location.reload();
        }
        
        async function loadData() {
            try {
                // Load summary stats
                const statusRes = await fetch(`${API_BASE}/status`, { credentials: 'include' });
                if (!statusRes.ok) {
                    if (statusRes.status === 401) location.reload();
                    return;
                }
                const status = await statusRes.json();
                
                document.getElementById('totalCustomers').textContent = status.total_customers || 0;
                document.getElementById('connectedCustomers').textContent = status.connected_customers || 0;
                document.getElementById('errorCustomers').textContent = status.customers_with_errors || 0;
                document.getElementById('totalPending').textContent = Number(status.total_pending || 0).toLocaleString();
                document.getElementById('lastHourSaved').textContent = status.last_hour_saved || 0;
                document.getElementById('totalSaved').textContent = Number(status.total_saved || 0).toLocaleString();
                
                // Load customers
                const customersRes = await fetch(`${API_BASE}/customers`, { credentials: 'include' });
                const customers = await customersRes.json();
                
                renderCustomers(customers);
            } catch (e) {
                console.error('Load data error:', e);
            }
        }
        
        function renderCustomers(customers) {
            const grid = document.getElementById('customersGrid');
            
            if (!customers || customers.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">××™×Ÿ ×œ×§×•×—×•×ª ×œ×”×¦×’×”</p>';
                return;
            }
            
            // Split into active and inactive
            const activeCustomers = customers.filter(c => 
                Number(c.total_pending) > 0 || c.last_month_activity > 0 || c.has_valid_tokens
            );
            const inactiveCustomers = customers.filter(c => 
                Number(c.total_pending) === 0 && !c.last_month_activity && !c.has_valid_tokens
            );
            
            let html = '';
            
            if (activeCustomers.length > 0) {
                html += `<div class="section-divider" style="grid-column: 1/-1; margin: 0.5rem 0 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--success); color: var(--success); font-weight: 600;">ğŸŸ¢ ×œ×§×•×—×•×ª ×¤×¢×™×œ×™× (${activeCustomers.length})</div>`;
                html += activeCustomers.map(c => renderCustomerCard(c)).join('');
            }
            
            if (inactiveCustomers.length > 0) {
                html += `<div class="section-divider" style="grid-column: 1/-1; margin: 2rem 0 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--text-light); color: var(--text-light); font-weight: 600;">âšª ×œ×§×•×—×•×ª ×œ× ×¤×¢×™×œ×™× (${inactiveCustomers.length})</div>`;
                html += inactiveCustomers.map(c => renderCustomerCard(c, true)).join('');
            }
            
            grid.innerHTML = html;
        }
        
        function renderCustomerCard(c, inactive = false) {
            const opacity = inactive ? 'opacity: 0.7;' : '';
            return `
                <div class="customer-card" onclick="openCustomerDetail('${c.phone}')" style="${opacity}">
                    <div class="customer-card-header">
                        <div class="customer-info">
                            <h3>${c.full_name || '×œ×œ× ×©×'}</h3>
                            <div class="phone">${c.phone || '-'}</div>
                        </div>
                        <div class="customer-status">
                            ${c.has_valid_tokens 
                                ? '<span class="badge badge-success">××—×•×‘×¨</span>' 
                                : '<span class="badge badge-warning">×œ× ××—×•×‘×¨</span>'}
                            ${c.last_error 
                                ? '<span class="badge badge-danger">×©×’×™××”</span>' 
                                : ''}
                            ${Number(c.total_pending) > 0 
                                ? '<span class="badge badge-warning">×××ª×™× ×™×</span>' 
                                : ''}
                        </div>
                    </div>
                    <div class="customer-card-stats">
                        <div class="mini-stat">
                            <div class="label">×§××¤×™×™× ×™×</div>
                            <div class="value" style="color: var(--primary)">${c.campaign_count || 0}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">×××ª×™× ×™×</div>
                            <div class="value" style="color: var(--warning)">${Number(c.total_pending || 0).toLocaleString()}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">× ×©××¨×•</div>
                            <div class="value" style="color: var(--success)">${Number(c.total_saved || 0).toLocaleString()}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">×§×™×™××™×</div>
                            <div class="value" style="color: var(--text-light)">${Number(c.total_existed || 0).toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="customer-card-footer">
                        <span>${c.email || '-'}</span>
                        ${c.last_hour_saved > 0 
                            ? `<span class="last-hour-badge">+${c.last_hour_saved} ×‘×©×¢×”</span>` 
                            : c.last_month_activity > 0 
                                ? `<span style="font-size: 0.8rem; color: var(--success);">×¤×¢×™×œ ×”×—×•×“×©</span>`
                                : ''}
                    </div>
                </div>
            `;
        }
        
        async function openCustomerDetail(phone) {
            document.getElementById('customerModal').classList.add('active');
            document.getElementById('modalBody').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>×˜×•×¢×Ÿ ×¤×¨×˜×™×...</p>
                </div>
            `;
            
            try {
                const res = await fetch(`${API_BASE}/customers/${phone}`, { credentials: 'include' });
                const data = await res.json();
                
                if (!res.ok) {
                    document.getElementById('modalBody').innerHTML = `<p>×©×’×™××”: ${data.error}</p>`;
                    return;
                }
                
                renderCustomerDetail(data);
            } catch (e) {
                document.getElementById('modalBody').innerHTML = `<p>×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</p>`;
            }
        }
        
        function renderCustomerDetail(data) {
            const { customer, campaigns, summary, recentActivity } = data;
            
            document.getElementById('modalTitle').textContent = customer.full_name || customer.phone;
            
            let html = '';
            
            // Error alert
            if (customer.last_error) {
                html += `
                    <div class="error-alert">
                        <span class="icon">âš ï¸</span>
                        <div class="text">
                            <div class="type">${customer.last_error_type || '×©×’×™××”'}</div>
                            <div>${customer.last_error}</div>
                        </div>
                    </div>
                `;
            }
            
            // Summary stats
            html += `
                <div class="detail-summary">
                    <div class="detail-stat">
                        <div class="label">×¡×”"×› ×× ×©×™ ×§×©×¨</div>
                        <div class="value" style="color: var(--primary)">${Number(summary.total_contacts).toLocaleString()}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="label">×××ª×™× ×™×</div>
                        <div class="value" style="color: var(--warning)">${Number(summary.total_pending).toLocaleString()}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="label">× ×©××¨×•</div>
                        <div class="value" style="color: var(--success)">${Number(summary.total_saved).toLocaleString()}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="label">×›×‘×¨ ×§×™×™××™×</div>
                        <div class="value" style="color: var(--text-light)">${Number(summary.total_existed).toLocaleString()}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="label">× ×©××¨×• ×‘×©×¢×”</div>
                        <div class="value" style="color: var(--success)">${summary.last_hour_saved}</div>
                    </div>
                </div>
            `;
            
            // Campaigns table
            if (campaigns && campaigns.length > 0) {
                html += `
                    <div class="campaigns-section">
                        <h3>ğŸ“ ×§××¤×™×™× ×™× (${campaigns.length})</h3>
                        <table class="campaign-table">
                            <thead>
                                <tr>
                                    <th>×©× ×§××¤×™×™×Ÿ</th>
                                    <th>×¡×”"×›</th>
                                    <th>×××ª×™× ×™×</th>
                                    <th>× ×©××¨×•</th>
                                    <th>×§×™×™××™×</th>
                                    <th>×¢×“×›×•×Ÿ ××—×¨×•×Ÿ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${campaigns.map(c => `
                                    <tr>
                                        <td><strong>${c.campaign_name}</strong></td>
                                        <td>${c.total_contacts}</td>
                                        <td style="color: var(--warning)">${c.pending_count}</td>
                                        <td style="color: var(--success)">${c.saved_count}</td>
                                        <td>${c.existed_count}</td>
                                        <td style="font-size: 0.85rem; color: var(--text-light)">
                                            ${c.last_processed ? new Date(c.last_processed).toLocaleString('he-IL') : '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Recent activity
            if (recentActivity && recentActivity.length > 0) {
                html += `
                    <div class="campaigns-section">
                        <h3>ğŸ“‹ ×¤×¢×™×œ×•×ª ××—×¨×•× ×”</h3>
                        <table class="campaign-table">
                            <thead>
                                <tr>
                                    <th>×©×</th>
                                    <th>×˜×œ×¤×•×Ÿ</th>
                                    <th>×§××¤×™×™×Ÿ</th>
                                    <th>×¡×˜×˜×•×¡</th>
                                    <th>×–××Ÿ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentActivity.slice(0, 20).map(a => `
                                    <tr>
                                        <td>${a.contact_name || '-'}</td>
                                        <td dir="ltr">${a.contact_phone}</td>
                                        <td style="font-size: 0.85rem">${a.campaign_name}</td>
                                        <td>
                                            <span class="badge ${
                                                a.status === 'saved' ? 'badge-success' :
                                                a.status === 'existed' ? 'badge-warning' :
                                                a.status === 'error' ? 'badge-danger' : ''
                                            }">
                                                ${a.status === 'saved' ? '× ×©××¨' :
                                                  a.status === 'existed' ? '×§×™×™×' :
                                                  a.status === 'error' ? '×©×’×™××”' : a.status}
                                            </span>
                                        </td>
                                        <td style="font-size: 0.8rem; color: var(--text-light)">
                                            ${a.processed_at ? new Date(a.processed_at).toLocaleString('he-IL') : '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            document.getElementById('modalBody').innerHTML = html;
        }
        
        function closeModal() {
            document.getElementById('customerModal').classList.remove('active');
        }
        
        // Close modal on click outside
        document.getElementById('customerModal').addEventListener('click', (e) => {
            if (e.target.id === 'customerModal') closeModal();
        });
        
        // Close modal on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
        
        async function runSaver() {
            try {
                const res = await fetch(`${API_BASE}/run-saver`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (res.ok) {
                    alert('×©××™×¨×ª ×× ×©×™ ×§×©×¨ ×”×•×¤×¢×œ×”');
                    setTimeout(loadData, 5000);
                }
            } catch (e) {
                alert('×©×’×™××” ×‘×”×¤×¢×œ×ª ×”×©××™×¨×”');
            }
        }
        
        async function migrateTokens() {
            if (!confirm('×”×× ×œ×”×¦×¤×™×Ÿ ××ª ×›×œ ×”×˜×•×§× ×™× ×”×§×™×™××™×?')) return;
            
            try {
                const res = await fetch(`${API_BASE}/migrate-tokens`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    alert(`×”×¦×¤× ×” ×”×•×©×œ××”!\n×”×•×¦×¤× ×•: ${data.migrated}\n×›×‘×¨ ××•×¦×¤× ×™×: ${data.skipped}`);
                } else {
                    alert('×©×’×™××” ×‘×”×¦×¤× ×”: ' + data.error);
                }
            } catch (e) {
                alert('×©×’×™××” ×‘×”×¦×¤× ×ª ×”×˜×•×§× ×™×');
            }
        }
        
        // Auto refresh every 30 seconds
        setInterval(() => {
            if (document.getElementById('dashboard').classList.contains('active')) {
                loadData();
            }
        }, 30000);
        
        init();
    </script>
</body>
</html>
